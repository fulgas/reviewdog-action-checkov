name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Build multi-platform Docker image to validate both architectures
  build-multiplatform:
    name: Build Multi-Platform Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf # v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Build multi-platform Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: false
          tags: reviewdog-action-checkov:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Test functionality on multiple OS versions
  test:
    name: Test ${{ matrix.framework }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: build-multiplatform
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-22.04]
        framework: [terraform, cloudformation, kubernetes]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Build Docker image from Dockerfile
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          load: true
          tags: reviewdog-action-checkov:test
          cache-from: type=gha

      - name: Run Checkov for ${{ matrix.framework }} on ${{ matrix.os }}
        id: checkov
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_FRAMEWORK: ${{ matrix.framework }}
          INPUT_WORKING_DIRECTORY: "."
          INPUT_TARGET_DIR: "tests/${{ matrix.framework }}"
          INPUT_REPORTER: "local"
          INPUT_FILTER_MODE: "nofilter"
          INPUT_FAIL_LEVEL: "none"
          INPUT_LEVEL: "error"
          INPUT_SKIP_CHECK: ""
          INPUT_FLAGS: ""
        run: |
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/github/workspace" \
            -e GITHUB_WORKSPACE=/github/workspace \
            -e GITHUB_OUTPUT=/tmp/github_output \
            -e GITHUB_TOKEN="${GITHUB_TOKEN}" \
            -e INPUT_GITHUB_TOKEN="${INPUT_GITHUB_TOKEN}" \
            -e INPUT_FRAMEWORK="${INPUT_FRAMEWORK}" \
            -e INPUT_WORKING_DIRECTORY="${INPUT_WORKING_DIRECTORY}" \
            -e INPUT_TARGET_DIR="${INPUT_TARGET_DIR}" \
            -e INPUT_REPORTER="${INPUT_REPORTER}" \
            -e INPUT_FILTER_MODE="${INPUT_FILTER_MODE}" \
            -e INPUT_FAIL_LEVEL="${INPUT_FAIL_LEVEL}" \
            -e INPUT_LEVEL="${INPUT_LEVEL}" \
            -e INPUT_SKIP_CHECK="${INPUT_SKIP_CHECK}" \
            -e INPUT_FLAGS="${INPUT_FLAGS}" \
            reviewdog-action-checkov:test > /tmp/action_output.txt 2>&1 || true
          
          cat /tmp/action_output.txt
          
          # Extract return codes from output
          CHECKOV_CODE=$(grep "Checkov exit code:" /tmp/action_output.txt | awk '{print $4}' || echo "unknown")
          REVIEWDOG_CODE=$(grep "Reviewdog exit code:" /tmp/action_output.txt | awk '{print $4}' || echo "unknown")
          
          echo "checkov-return-code=${CHECKOV_CODE}" >> $GITHUB_OUTPUT
          echo "reviewdog-return-code=${REVIEWDOG_CODE}" >> $GITHUB_OUTPUT

      - name: Display results for ${{ matrix.framework }} on ${{ matrix.os }}
        if: always()
        run: |
          echo "### Test Results for ${{ matrix.framework }} on ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          CHECKOV_CODE="${{ steps.checkov.outputs.checkov-return-code }}"
          REVIEWDOG_CODE="${{ steps.checkov.outputs.reviewdog-return-code }}"
          
          echo "**Step outputs:**" >> $GITHUB_STEP_SUMMARY
          echo "- Checkov exit code: \`${CHECKOV_CODE}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Reviewdog exit code: \`${REVIEWDOG_CODE}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Console output
          echo "Checkov return code: ${CHECKOV_CODE}"
          echo "Reviewdog return code: ${REVIEWDOG_CODE}"
          
          # Validate expected results
          if [ "${CHECKOV_CODE}" = "1" ] && [ "${REVIEWDOG_CODE}" = "0" ]; then
            echo "✅ Expected results: Checkov found issues (1), Reviewdog handled gracefully (0)" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Unexpected results!" >> $GITHUB_STEP_SUMMARY
            echo "  - Expected Checkov: 1, Got: ${CHECKOV_CODE}" >> $GITHUB_STEP_SUMMARY
            echo "  - Expected Reviewdog: 0, Got: ${REVIEWDOG_CODE}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if unexpected results
        if: always()
        run: |
          CHECKOV_CODE="${{ steps.checkov.outputs.checkov-return-code }}"
          REVIEWDOG_CODE="${{ steps.checkov.outputs.reviewdog-return-code }}"
          
          if [ "${CHECKOV_CODE}" != "1" ] || [ "${REVIEWDOG_CODE}" != "0" ]; then
            echo "::error::Unexpected exit codes for ${{ matrix.framework }} on ${{ matrix.os }}"
            echo "::error::Expected: Checkov=1, Reviewdog=0"
            echo "::error::Got: Checkov=${CHECKOV_CODE}, Reviewdog=${REVIEWDOG_CODE}"
            exit 1
          else
            echo "::notice::${{ matrix.framework }} on ${{ matrix.os }} passed with expected exit codes"
          fi