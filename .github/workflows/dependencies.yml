name: 'Auto-update Dependencies'

on:
  schedule:
    - cron: '0 9 * * *' # Run daily at 9:00 AM UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    name: Check for new tool versions and update

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get latest tool versions
        id: get_versions
        run: |
          # --- Get Checkov version ---
          echo "Fetching latest Checkov release..."
          LATEST_CHECKOV=$(curl -sL https://api.github.com/repos/bridgecrewio/checkov/releases/latest | jq -r '.tag_name')
          CURRENT_CHECKOV=$(grep "ENV CHECKOV_VERSION" Dockerfile | cut -d '=' -f 2)
          echo "checkov-latest=${LATEST_CHECKOV}" >> $GITHUB_OUTPUT
          echo "checkov-current=${CURRENT_CHECKOV}" >> $GITHUB_OUTPUT
          echo "Checkov: Current=${CURRENT_CHECKOV}, Latest=${LATEST_CHECKOV}"

          echo "Fetching latest reviewdog release..."
          LATEST_REVIEWDOG=$(curl -sL https://api.github.com/repos/reviewdog/reviewdog/releases/latest | jq -r '.tag_name')
          CURRENT_REVIEWDOG=$(grep "ENV REVIEWDOG_VERSION" Dockerfile | cut -d '=' -f 2)
          echo "reviewdog-latest=${LATEST_REVIEWDOG}" >> $GITHUB_OUTPUT
          echo "reviewdog-current=${CURRENT_REVIEWDOG}" >> $GITHUB_OUTPUT
          echo "reviewdog: Current=${CURRENT_REVIEWDOG}, Latest=${LATEST_REVIEWDOG}"

      - name: Prepare Changes
        id: prepare-changes
        if: steps.get_versions.outputs.checkov-latest != steps.get_versions.outputs.checkov-current || steps.get_versions.outputs.reviewdog-latest != steps.get_versions.outputs.reviewdog-current
        run: |
          # --- Prepare changes ---
          MADE_CHANGES=false
          CHANGELOG=""
          
          if [ "${{ steps.get_versions.outputs.checkov-latest }}" != "${{ steps.get_versions.outputs.checkov-current }}" ]; then
            echo "‚úÖ New Checkov version found: ${{ steps.get_versions.outputs.checkov-current }} -> ${{ steps.get_versions.outputs.checkov-latest }}"
            sed -i "s/ENV CHECKOV_VERSION=${{ steps.get_versions.outputs.checkov-current }}/ENV CHECKOV_VERSION=${{ steps.get_versions.outputs.checkov-latest }}/" Dockerfile
          
            # Update Checkov badge in README
            sed -i "s/Checkov-[0-9.]*-6B46C1/Checkov-${{ steps.get_versions.outputs.checkov-latest }}-6B46C1/" README.md
          
            MADE_CHANGES=true
            CHANGELOG+="- checkov: ${{ steps.get_versions.outputs.checkov-current }} -> ${{ steps.get_versions.outputs.checkov-latest }}\n"
          else
            echo "‚ÑπÔ∏è Checkov is already up-to-date."
          fi
          if [ "${{ steps.get_versions.outputs.reviewdog-latest }}" != "${{ steps.get_versions.outputs.reviewdog-current }}" ]; then
            echo "‚úÖ New reviewdog version found: ${{ steps.get_versions.outputs.reviewdog-current }} -> ${{ steps.get_versions.outputs.reviewdog-latest }}"
            sed -i "s/ENV REVIEWDOG_VERSION=${{ steps.get_versions.outputs.reviewdog-current }}/ENV REVIEWDOG_VERSION=${{ steps.get_versions.outputs.reviewdog-latest }}/" Dockerfile
          
            REVIEWDOG_VERSION_NO_V="${{ steps.get_versions.outputs.reviewdog-latest }}"
            REVIEWDOG_VERSION_NO_V="${REVIEWDOG_VERSION_NO_V#v}"
            sed -i "s/Reviewdog-[0-9.]*-F97316/Reviewdog-${REVIEWDOG_VERSION_NO_V}-F97316/" README.md
          
            MADE_CHANGES=true
            CHANGELOG+="- reviewdog: ${{ steps.get_versions.outputs.reviewdog-current }} -> ${{ steps.get_versions.outputs.reviewdog-latest }}\n"
          else
            echo "‚ÑπÔ∏è reviewdog is already up-to-date."
          fi
          if [ "$MADE_CHANGES" = true ]; then
            echo "üöÄ Changes detected. Preparing to create a PR."
            echo "made_changes=true" >> $GITHUB_OUTPUT
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo -e "${CHANGELOG}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "made_changes=false" >> $GITHUB_OUTPUT
            echo "üëç No dependency updates needed."
          fi

      - name: Create Pull Request
        if: steps.prepare-changes.outputs.made_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: |
            feat: update dependencies
            
            ${{ steps.prepare-changes.outputs.changelog }}

          title: 'feat: automated dependency updates'
          body: |
            ## Automated Dependency Update
            
            This PR was automatically created because new versions of dependencies were detected.
            
            ### Changes:
            ${{ steps.prepare-changes.outputs.changelog }}
            
            ### Files Updated:
            - `Dockerfile` - Updated version environment variables
            - `README.md` - Updated version badges
            
            ---
            
            ‚úÖ Once all checks pass, this PR can be merged automatically.
          branch: 'feat/dependency-updates'
          branch-suffix: timestamp
          sign-commits: true
          delete-branch: true
          labels: |
            dependencies
            reviewdog
            checkov
            automated